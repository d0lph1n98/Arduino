//in case of a \r\nRING\r\n, detect the phonenumber and send this to the Serial terminal of the computer
//uses RX/TX of arduino for PC communication
//uses software serial port for rx/td to TC35 board.
//all received data from the phone is displayed in the terminal
 
#include <SoftwareSerial.h>
//#include <TFT.h>
//#include <SPI.h>

// pin definition for the Uno
//#define cs  7
//#define dc  9
//#define rst  8
//#include <LiquidCrystal.h>

//TFT screen = TFT(cs, dc, rst);
//LiquidCrystal lcd(12,11,6,7,5,4);
SoftwareSerial gsmSerial(2,3);

//String lcdtext="";
//char LCDprint[20];
int led=13;
char receivedByte;
int index;
char buffer[100];
int flagRING=0;
int numberFlag=0;
int j;
int telStart,telEnd;
String phoneNumber;
char gsm_char,gsm_char_send;
String cellContent=""; //string we're sending
String ctlZ="\x1A"; //the code for Ctrl-Z
String SMScontent=""; //the actual SMS message || 
//char fonnumber;
 
void setup(){
  //screen.begin();
  //screen.background(0,0,0);
  //screen.stroke(255,255,255);
  //screen.setTextSize(2);
  //screen.text("The caller number is:",0,0);
  //lcd.begin(16,2);
  pinMode(13, OUTPUT);
  Serial.begin(9600);
  gsmSerial.begin(9600);
 
  Serial.println("\r\nCommunication started\r\n");
 
  //start communication with GSM
  gsmSerial.print("AT\r");
  delay(400);
  //PIN not necessary
  gsmSerial.print("AT+CPIN=0000\r");
  delay(400);
//Enable number of calling phone, without this command
//only \r\nRING\r\n is receivied in case of an incoming call
  gsmSerial.print("AT+CLIP=1\r");
  delay(400);
}
 
void loop(){
 
  if(gsmSerial.available()>0){
 
    receivedByte = gsmSerial.read();
        //Serial.print(receivedByte);
        buffer[index]=receivedByte;
 
        if(flagRING==0)
        {
        if(receivedByte == '\n'){
              index =0;
              buffer[index]=NULL;
              //Serial.println("newline received");
            }
            else{
              index++;
 
              if(index==4  && buffer[3]=='G' && buffer[2]=='N' && buffer[1]=='I' && buffer[0]=='R'){
                digitalWrite(led, HIGH);
                delay(5000);
                digitalWrite(led, LOW);
                //search for telephone string
 
                flagRING=1;
              }
            }
         }
        //if RING
        if(flagRING==1){
 
            if(receivedByte==':'){    //first number of telephone
                telStart=index+2;           //first number (that is the the second character after ':' (first character is a space)
            }
            if(receivedByte==','){
                //last number of telephone number
                numberFlag=1;
                telEnd=index;  //remove comma
            }
            index++;
 
        }
 
   }
   if(numberFlag==1){
     for(j=telStart;j<telEnd;j++){
         phoneNumber=phoneNumber+buffer[j];
 
 
     }
      //screen.text("The number is:",0,0);
      //lcdtext+=phoneNumber;
      //fonnumber+=phoneNumber;
      //screen.text(fonnumber,0,20);
      //lcd.print(phoneNumber);
      SMScontent+=phoneNumber; 
      cellContent+=SMScontent;
      cellContent+=ctlZ;
      gsmSerial.print("AT+CMGF=1\r");
      delay(400);
      sendSMS();
      Serial.println("\r\nThe calling phone number is:");
      Serial.println(phoneNumber);
      Serial.print("\r\n"); 
      numberFlag=0;
      flagRING=0;
      phoneNumber=0;
      index=0;
      buffer[index]=NULL;
      gsmSerial.write("\r");
   }
 
 //when the character c is received from the terminal of the computer
 //call a number (feature just for testing TC35 board)
  if(Serial.available() >0){
    gsm_char=Serial.read();
     if(gsm_char=='c')
     {
       gsmSerial.write("ATD+phonenumber;\r");
     }
  }
 
}

void sendSMS() {
  gsmSerial.println("AT+CMGS=\"0193954263\"");
  delay(500);
  gsmSerial.print(cellContent);
  delay(500);
}
